<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Assistant</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
    .cursor { display:inline-block; width:1ch; animation: blink 1s steps(1) infinite; }
    @keyframes blink { 50% { opacity:0; } }
</style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

<header class="bg-gray-800 text-white py-4 px-6 flex justify-between items-center text-2xl font-bold">
    <span>Agent Assistant</span>
    <a href="{{ url_for('dashboard') }}" class="bg-gray-900 px-3 py-1 rounded hover:bg-gray-700">Logout</a>
</header>

<div class="flex-1 overflow-auto p-4" id="chat-container">
    <!-- Messages will appear here -->
</div>

<form id="chat-form" class="flex p-4 bg-white">
    <input type="text" id="chat-input" class="flex-1 border p-2 rounded-l focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message...">
    <button type="submit" class="bg-blue-500 text-white px-4 rounded-r hover:bg-blue-600">Send</button>
</form>

<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-input');
const container = document.getElementById('chat-container');

function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

async function typeText(element, text, speed = 20) {
    let cursor = document.createElement('span');
    cursor.className = 'cursor';
    element.appendChild(cursor);
    for (let i=0;i<text.length;i++){
        element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
        await sleep(speed);
        container.scrollTop = container.scrollHeight;
    }
    cursor.remove();
}

form.addEventListener('submit', async e => {
    e.preventDefault();
    const userMsg = input.value.trim();
    if (!userMsg) return;

    // Show user message
    const userDiv = document.createElement('div');
    userDiv.classList.add('text-right', 'mb-2');
    userDiv.innerHTML = `<strong>You:</strong> ${userMsg}`;
    container.appendChild(userDiv);

    // Clear input
    input.value = '';

    // Show thinking animation
    const thinkingDiv = document.createElement('div');
    thinkingDiv.classList.add('text-left', 'mb-2', 'italic', 'text-gray-500');
    thinkingDiv.innerHTML = 'AI is thinking...';
    container.appendChild(thinkingDiv);
    container.scrollTop = container.scrollHeight;

    // Call backend
    const response = await fetch(`/agent/{{ company.id }}/agent_api`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message:userMsg})
    });
    const data = await response.json();

    // Remove thinking
    thinkingDiv.remove();

    // Show AI response dynamically
    const aiDiv = document.createElement('div');
    aiDiv.classList.add('text-left', 'mb-2');
    container.appendChild(aiDiv);

    const answerDiv = document.createElement('div');
    answerDiv.innerHTML = "<strong>Answer:</strong> ";
    aiDiv.appendChild(answerDiv);
    await typeText(answerDiv, data.answer);

    const scriptDiv = document.createElement('div');
    scriptDiv.innerHTML = "<strong>Script:</strong> ";
    aiDiv.appendChild(scriptDiv);
    await typeText(scriptDiv, data.script);
});
</script>

</body>
</html>
