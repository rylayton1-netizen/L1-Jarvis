{% extends "base.html" %}
{% block title %}Agent Assistant{% endblock %}
{% block content %}
<div class="flex justify-between mb-4">
    <h2 class="text-xl font-bold">Agent Assistant - {{ company.name }}</h2>
    <a href="{{ url_for('dashboard') }}" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-900">Dashboard</a>
</div>

<div id="chat-container" class="bg-white p-4 rounded shadow h-96 overflow-auto mb-4"></div>

<form id="chat-form" class="flex space-x-2">
    <input type="text" id="chat-input" placeholder="Type message..." class="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Send</button>
</form>

<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-input');
const container = document.getElementById('chat-container');

form.addEventListener('submit', async e => {
    e.preventDefault();
    const userMsg = input.value.trim();
    if(!userMsg) return;
    const userDiv = document.createElement('div');
    userDiv.className = "text-right mb-2 p-2 rounded bg-blue-100";
    userDiv.innerHTML = `<strong>You:</strong> ${userMsg}`;
    container.appendChild(userDiv);
    input.value = '';

    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = "text-left mb-2 italic text-gray-500";
    thinkingDiv.innerText = "AI is thinking...";
    container.appendChild(thinkingDiv);
    container.scrollTop = container.scrollHeight;

    try {
        const res = await fetch('/agent_api', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message: userMsg})
        });
        const data = await res.json();
        thinkingDiv.remove();
        const aiDiv = document.createElement('div');
        aiDiv.className = "text-left mb-4 p-2 rounded bg-gray-200 shadow";
        aiDiv.innerHTML = `<strong>Answer:</strong><br>${data.answer}<br><strong>Script:</strong><br>${data.script}`;
        container.appendChild(aiDiv);
        container.scrollTop = container.scrollHeight;
    } catch(err) {
        thinkingDiv.remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = "text-left mb-4 p-2 rounded bg-red-100 text-red-700";
        errorDiv.innerText = "Error: Failed to get AI response.";
        container.appendChild(errorDiv);
    }
});
</script>
{% endblock %}
