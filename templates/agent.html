<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ company.name }} — Agent Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    .typing { display:inline-flex; gap:6px; align-items:center; }
    .typing .dot { width:6px;height:6px;border-radius:9999px;background:#9CA3AF;animation:blink 1.2s infinite; }
    .typing .dot:nth-child(2){ animation-delay:.2s; }
    .typing .dot:nth-child(3){ animation-delay:.4s; }
    @keyframes blink{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}
    #chat-box::-webkit-scrollbar { width: 8px; } #chat-box::-webkit-scrollbar-thumb { background:#E5E7EB;border-radius:9999px } #chat-box:hover::-webkit-scrollbar-thumb{background:#D1D5DB}
    .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: #e5e7eb; border-radius: 9999px; transition: .2s; }
    .slider:before { content: ""; position: absolute; height: 20px; width: 20px; left: 2px; top: 2px; background: #fff; border-radius: 9999px; transition: .2s; box-shadow: 0 1px 2px rgba(0,0,0,.2); }
    .switch input:checked + .slider { background: #111827; }
    .switch input:checked + .slider:before { transform: translateX(18px); }
    .switch:focus-within .slider { box-shadow: 0 0 0 2px rgba(17,24,39,.2); }

    /* Source list niceties */
    .src-domain { font-size: 11px; color: #6B7280; }
    .src-quote { font-size: 12px; color: #374151; background: #F9FAFB; border-left: 3px solid #E5E7EB; padding: .5rem .75rem; border-radius: .375rem; }
    .src-meta { font-size: 11px; color: #6B7280; }
    .src-link { color:#111827; text-decoration:underline; }
    .badge { font-size: 10px; background:#F3F4F6; border:1px solid #E5E7EB; color:#4B5563; border-radius:9999px; padding:2px 6px; }
  </style>
</head>
<body class="bg-gray-100">
  <main class="flex flex-col h-screen">
    <header class="bg-white border-b px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 rounded-xl bg-gray-900 text-white flex items-center justify-center font-bold">L1</div>
        <h1 class="text-lg md:text-xl font-semibold text-gray-900">{{ company.name }}</h1>
      </div>
      <div class="flex items-center space-x-2 select-none">
        <span class="text-xs text-gray-600">Show sources</span>
        <label class="switch">
          <input id="toggle-sources" type="checkbox">
          <span class="slider"></span>
        </label>
      </div>
    </header>

    <section id="chat-box" class="flex-1 overflow-y-auto px-3 md:px-6 py-4 md:py-6 space-y-4"></section>

    <footer class="sticky bottom-0 w-full bg-gradient-to-t from-gray-100 to-gray-100/70 pt-2 pb-4 px-3 md:px-6">
      <div class="max-w-5xl mx-auto">
        <div class="bg-white border rounded-2xl shadow-sm flex items-end p-2">
          <textarea id="user-input" rows="1" placeholder="Message…" class="flex-1 resize-none outline-none px-3 py-2 rounded-xl placeholder-gray-400 text-gray-900" style="max-height: 180px; overflow-y: auto;"></textarea>
          <button id="send-btn" class="ml-2 px-4 py-2 bg-gray-900 text-white rounded-xl hover:bg-gray-800 transition" title="Send (Enter)">Send</button>
        </div>
        <p class="text-xs text-gray-400 mt-2">Press Enter to send • Shift + Enter for a new line</p>
      </div>
    </footer>
  </main>

  <script>
    // -------- Dual-mode plumbing (normal vs embed) --------
    const qs = new URLSearchParams(location.search);
    const TOKEN = qs.get('token');                 // present in embed mode
    const isEmbed = !!TOKEN;
    const API_URL = isEmbed
      ? '/agent_api'                                // token carries company_id in backend
      : `{{ url_for("agent_api") }}?company_id={{ company.id }}`;
    const BASE_HEADERS = isEmbed
      ? { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` }
      : { 'Content-Type': 'application/json' };

    // -------- Existing UI logic --------
    const chatBox = document.getElementById('chat-box');
    const inputEl = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const toggleEl = document.getElementById('toggle-sources');

    let isSending = false;
    let showSources = JSON.parse(localStorage.getItem('showSources') || 'true');

    function nl2br(t){return (t||'').replace(/\n/g,'<br>')}
    function escapeHtml(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;")}
    function scrollToBottom(){chatBox.scrollTop=chatBox.scrollHeight}
    function autoResize(){inputEl.style.height='auto';inputEl.style.height=Math.min(inputEl.scrollHeight,180)+'px'}

    function appendBubble(htmlSafeText, role){
      const wrap=document.createElement('div');
      wrap.className=(role==='user')?'flex justify-end':'flex justify-start';
      const bubble=document.createElement('div');
      bubble.className=(role==='user')?'max-w-3xl bg-gray-900 text-white px-4 py-3 rounded-2xl rounded-tr-md shadow'
                                       :'max-w-3xl bg-white text-gray-900 px-4 py-3 rounded-2xl rounded-tl-md shadow border';
      bubble.innerHTML=htmlSafeText; wrap.appendChild(bubble); chatBox.appendChild(wrap); scrollToBottom(); return bubble;
    }
    function appendThinking(){
      const wrap=document.createElement('div'); wrap.className='flex justify-start';
      const bubble=document.createElement('div'); bubble.className='max-w-3xl bg-white text-gray-900 px-4 py-3 rounded-2xl rounded-tl-md shadow border';
      bubble.innerHTML=`<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
      wrap.appendChild(bubble); chatBox.appendChild(wrap); scrollToBottom(); return bubble;
    }

    // Removes any inline "Source: ..." tails some models append
    function stripInlineSourceSuffix(s){
      if(!s) return s;
      const lines = s.replace(/\s+$/,'').split(/\r?\n/);
      const tailRe = /^(?:\[\d+\]\s*)?(?:file|source)\s*:\s*.*/i;
      while(lines.length && tailRe.test(lines[lines.length-1].trim())){
        lines.pop();
      }
      return lines.join('\n').replace(/\s+$/,'');
    }

    function domainFromUrl(url){
      try{ return new URL(url).hostname.replace(/^www\./,''); }catch{ return ''; }
    }

    // Build one source card with title/filename, clickable URL, and a verbatim quote/snippet
    function buildSourceItem(s, index){
      const item=document.createElement('div');
      item.className='p-2 bg-white border rounded-lg';

      const title = s.title || s.filename || s.name || '(untitled)';
      const url = s.url || s.link || '';
      const domain = url ? domainFromUrl(url) : '';
      const quote = s.quote || s.excerpt || s.snippet || '';
      const location = s.location || s.loc || null; // e.g., page/line info if your backend provides it

      // header line
      const head=document.createElement('div');
      head.className='text-sm font-medium text-gray-800 flex items-center gap-2';
      const label=document.createElement('span');
      label.textContent = `[${index+1}] ${title}`;
      head.appendChild(label);

      if (url){
        const link=document.createElement('a');
        link.href=url; link.target='_blank'; link.rel='noopener noreferrer';
        link.className='badge src-meta';
        link.textContent='Open';
        head.appendChild(link);
      }
      item.appendChild(head);

      // domain + optional location
      if (domain || location){
        const meta=document.createElement('div');
        meta.className='mt-1 src-domain';
        meta.textContent = [domain, location ? `• ${location}` : ''].filter(Boolean).join(' ');
        item.appendChild(meta);
      }

      // exact quote block (fallback to snippet)
      if (quote){
        const qb=document.createElement('blockquote');
        qb.className='mt-2 src-quote';
        qb.innerHTML=nl2br(escapeHtml(quote));
        item.appendChild(qb);
      }

      // raw URL line for transparency (optional)
      if (url){
        const rawUrl=document.createElement('div');
        rawUrl.className='mt-2 src-meta break-all';
        rawUrl.innerHTML = `<a class="src-link" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
        item.appendChild(rawUrl);
      }

      return item;
    }

    // Renders a dropdown labeled "Sources (N)" with clickable links and verbatim quotes
    function renderSourcesDropdown(bubble, sources){
      if(!showSources) return;
      if(!Array.isArray(sources) || sources.length===0) return;

      const details=document.createElement('details');
      details.className='mt-3 bg-gray-50 border rounded-xl';
      const summary=document.createElement('summary');
      summary.className='cursor-pointer select-none text-sm text-gray-700 px-3 py-2';
      summary.textContent=`Sources (${sources.length})`;
      details.appendChild(summary);

      const list=document.createElement('div');
      list.className='px-3 pb-3 space-y-2';

      sources.forEach((s, i)=>{
        list.appendChild(buildSourceItem(s, i));
      });

      details.appendChild(list);
      bubble.appendChild(details);
      scrollToBottom();
    }

    async function sendMessage(){
      const raw=inputEl.value; const message=raw.trim(); if(!message||isSending) return;
      appendBubble(nl2br(escapeHtml(message)),'user');
      inputEl.value=''; autoResize(); inputEl.disabled=true; sendBtn.disabled=true; isSending=true;
      const thinkingBubble=appendThinking();
      try{
        const res=await fetch(API_URL,{
          method:'POST',
          headers: BASE_HEADERS,
          body:JSON.stringify({message, show_sources: !!showSources})
        });

        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const txt = await res.text();
          console.error('Non-JSON from agent_api:', txt);
          throw new Error('Non-JSON response');
        }

        const data=await res.json();

        if(!res.ok){
          console.error('agent_api error:', data?.error || data);
          throw new Error(data?.error || 'Request failed');
        }

        const rawAnswer = (data && data.answer) || '';
        const cleaned = stripInlineSourceSuffix(rawAnswer);
        const answerSafe = nl2br(escapeHtml(cleaned));
        thinkingBubble.innerHTML = answerSafe;

        // Expecting sources like:
        // [{ title, filename, url, quote, snippet, location }, ...]
        const sources = Array.isArray(data?.sources) ? data.sources : [];
        renderSourcesDropdown(thinkingBubble, sources);

      }catch(e){
        console.error(e);
        thinkingBubble.innerHTML='<span class="text-red-600">Sorry, something went wrong.</span>';
      }finally{
        inputEl.disabled=false; sendBtn.disabled=false; inputEl.focus(); isSending=false; scrollToBottom();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()} });
    inputEl.addEventListener('input', autoResize);

    window.addEventListener('load', ()=>{
      inputEl.focus();
      autoResize();

      if (toggleEl) {
        toggleEl.checked = !!showSources;
        toggleEl.addEventListener('change', () => {
          showSources = toggleEl.checked;
          localStorage.setItem('showSources', JSON.stringify(showSources));
        });
      }
    });
  </script>
</body>
</html>
